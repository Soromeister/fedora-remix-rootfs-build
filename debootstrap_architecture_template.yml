jobs:
- job: startAgent
  pool: 
    vmImage: ubuntu-latest
  steps:

  - script: |
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      unzip awscliv2.zip
      sudo ./aws/install

- job: ${{ parameters.arch }}
  dependsOn: [ startAgent ]
  pool:
    name: Fedora
    demands:
      - Agent.OSArchitecture -equals ${{ parameters.agent_arch }}
  variables:
    ARCH: ${{ parameters.arch }}
    ARCHDIR: ${{ parameters.arch_dir }}
  steps:

  - script: |
      sudo rm -rf rootfs
      mkdir rootfs
    displayName: 'Creating rootfs folder'

  - script: sudo bash create-targz.sh $(ARCH) "$PWD/rootfs"
    displayName: 'Build image'

  - script: |
      cp $(ARCHDIR)/install.tar.gz $(Build.ArtifactStagingDirectory)/install_$(ARCHDIR)_rootfs.tar.gz
      sudo rm -rf $(ARCHDIR)/install.tar.gz
    displayName: 'Copy for publishing'

  - task: PublishBuildArtifacts@1

  - script: |
      sudo shutdown -r 1

    displayName: Clean up



