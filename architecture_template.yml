jobs:
- job: ${{ parameters.arch }}
  pool:
    vmImage: ubuntu-latest
  variables:
    BUILD_ARCH: ${{ parameters.arch }}
    MOCK_ARCH: ${{ parameters.mock_arch }}
  
  steps:
  - task: AzureCLI@1
    inputs:
      azureSubscription: 'Pay-As-You-Go(32f0131f-84dc-4502-99b2-c0a74a1423ce)'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az vm create \
          --resource-group Fedora \
          --name Build \
          --image 'tunnelbiz:fedora:fedora30:0.0.3' \
          --admin-username azureuser \
          --generate-ssh-keys
    displayName: 'Spinning Up Azure VM'

  - task: AzureCLI@1
    inputs:
      azureSubscription: 'Pay-As-You-Go(32f0131f-84dc-4502-99b2-c0a74a1423ce)'
      scriptLocation: 'inlineScript'
      inlineScript: |
        vmipaddress=$(az vm show -d -g Fedora -n Build --query publicIps -o tsv)
      displayName: 'Getting IP address of new VM'

  - task: Bash@3
    inputs:
      targetType: 'inline'
      script: ssh -o "StrictHostKeyChecking no" azureuser@$vmipaddress "echo 'hello world'"
    displayName: 'Logging into VM via ssh'
  
  - task: AzureCLI@1
    inputs:
      azureSubscription: 'Pay-As-You-Go(32f0131f-84dc-4502-99b2-c0a74a1423ce)'
      scriptLo cation: 'inlineScript'
      inlineScript: |
        az vm delete \
          --resource-group Fedora \
          --name Build \
          --yes
    displayName: 'Shutting down Azure VM'

- job: 'Shut down Azure VM after failed build'
  dependsOn: ${{ parameters.arch }}
  condition: failed()
  pool: 
    vmImage: ubuntu-latest

  steps:
  - task: AzureCLI@1
    inputs:
      azureSubscription: 'Pay-As-You-Go(32f0131f-84dc-4502-99b2-c0a74a1423ce)'
      scriptLo cation: 'inlineScript'
      inlineScript: |
        az vm delete \
          --resource-group Fedora \
          --name Build \
          --yes
    displayName: 'Shutting down Azure VM'